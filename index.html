<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Name Your Beast ‚Äî The ADHD Trait-to-Tool Map</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap');

:root {
  --red: #E8443A;
  --yellow: #F5A623;
  --blue: #4A90D9;
  --green: #5CB85C;
  --purple: #8E6FBF;
  --dark: #1E1E2E;
  --darker: #14141F;
  --card-bg: #252540;
  --card-hover: #2E2E50;
  --text-main: #E8E8F0;
  --text-muted: #9595B0;
  --accent: #FF6B6B;
  --glow: rgba(255, 107, 107, 0.15);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--darker);
  color: var(--text-main);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
}

/* ============ HERO ============ */
.hero {
  position: relative;
  padding: 4rem 2rem 3rem;
  text-align: center;
  background: linear-gradient(135deg, var(--darker) 0%, #1a1a35 50%, var(--darker) 100%);
  border-bottom: 1px solid rgba(255,255,255,0.04);
}

.hero::after {
  content: '';
  position: absolute;
  bottom: -60px;
  left: 50%;
  transform: translateX(-50%);
  width: 300px;
  height: 120px;
  background: radial-gradient(ellipse, var(--glow), transparent 70%);
  pointer-events: none;
}

.hero h1 {
  font-family: 'Fredoka', sans-serif;
  font-size: clamp(2.2rem, 5vw, 3.6rem);
  font-weight: 700;
  line-height: 1.15;
  letter-spacing: -0.02em;
  background: linear-gradient(135deg, #FF6B6B, #FFD93D, #6BCB77, #4D96FF);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 0.75rem;
}

.hero .subtitle {
  font-size: 1.15rem;
  color: var(--text-muted);
  max-width: 600px;
  margin: 0 auto 1.5rem;
  line-height: 1.55;
}

.hero .source-note {
  font-size: 0.8rem;
  color: #666;
  font-style: italic;
}

/* ============ NAV TABS ============ */
.nav-bar {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(20, 20, 31, 0.92);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  padding: 0.6rem 1rem;
  display: flex;
  gap: 0.5rem;
  overflow-x: auto;
  justify-content: center;
  flex-wrap: wrap;
}

.nav-btn {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  padding: 0.5rem 1.1rem;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 999px;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.nav-btn:hover { background: rgba(255,255,255,0.06); color: var(--text-main); }
.nav-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

.nav-btn.nav-myday {
  border-color: rgba(107,203,119,0.4);
  color: #6BCB77;
}
.nav-btn.nav-myday.active { background: #6BCB77; color: #000; border-color: #6BCB77; }
.nav-btn.nav-myday:hover:not(.active) { background: rgba(107,203,119,0.1); }

.nav-btn.nav-fav {
  border-color: rgba(255,217,61,0.4);
  color: #FFD93D;
}
.nav-btn.nav-fav.active { background: #FFD93D; color: #000; border-color: #FFD93D; }
.nav-btn.nav-fav:hover:not(.active) { background: rgba(255,217,61,0.1); }

/* ============ CONTAINER ============ */
.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 2rem 1.5rem 4rem;
  position: relative;
  z-index: 1;
}

/* ============ SECTION HEADERS ============ */
.section-header {
  margin: 3rem 0 1.5rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid rgba(255,255,255,0.06);
}

.section-header:first-child { margin-top: 0; }

.section-header h2 {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.7rem;
  font-weight: 600;
}

.section-header p {
  color: var(--text-muted);
  margin-top: 0.3rem;
  font-size: 0.95rem;
}

/* ============ TRAIT CARDS ============ */
.trait-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.25rem;
}

.trait-card {
  background: var(--card-bg);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.05);
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s;
  animation: cardFadeIn 0.3s ease both;
}

@keyframes cardFadeIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

.trait-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
}

.trait-header {
  padding: 1.25rem 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  user-select: none;
}

.trait-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
}

.trait-title-group { flex: 1; }

.trait-title-group h3 {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 0.15rem;
}

.trait-title-group .aka {
  font-size: 0.82rem;
  color: var(--text-muted);
  font-style: italic;
}

.expand-arrow {
  font-size: 1.2rem;
  color: var(--text-muted);
  transition: transform 0.3s;
}

.trait-card.open .expand-arrow { transform: rotate(180deg); }

.trait-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease;
}

.trait-card.open .trait-body {
  max-height: 5000px;
}

.trait-content {
  padding: 0 1.5rem 1.5rem;
}

/* Sub-sections inside trait */
.trait-section {
  margin-bottom: 1.25rem;
}

.trait-section-label {
  font-family: 'Fredoka', sans-serif;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 0.5rem;
  padding: 0.25rem 0.65rem;
  border-radius: 6px;
  display: inline-block;
}

.label-what { background: rgba(78,205,196,0.15); color: #4ECDC4; }
.label-feel { background: rgba(255,107,107,0.15); color: #FF6B6B; }
.label-tool { background: rgba(107,203,119,0.15); color: #6BCB77; }
.label-how { background: rgba(77,150,255,0.15); color: #4D96FF; }

.trait-section p, .trait-section li {
  color: var(--text-muted);
  font-size: 0.92rem;
  line-height: 1.65;
}

.trait-section ul {
  list-style: none;
  padding: 0;
}

.trait-section li {
  padding: 0.35rem 0 0.35rem 1.4rem;
  position: relative;
}

.trait-section li::before {
  content: '‚Üí';
  position: absolute;
  left: 0;
  color: var(--accent);
}

/* ============ TOOL CARDS ============ */
.tool-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  padding: 1rem 1.25rem;
  margin-bottom: 0.75rem;
  position: relative;
}

.tool-card h4 {
  font-family: 'Fredoka', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.4rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.tool-card .steps {
  counter-reset: step;
  list-style: none;
  padding: 0;
}

.tool-card .steps li {
  counter-increment: step;
  padding: 0.3rem 0 0.3rem 2rem;
  position: relative;
  color: var(--text-muted);
  font-size: 0.88rem;
  line-height: 1.55;
}

.tool-card .steps li::before {
  content: counter(step);
  position: absolute;
  left: 0;
  top: 0.35rem;
  width: 1.4rem;
  height: 1.4rem;
  border-radius: 50%;
  background: rgba(255,107,107,0.15);
  color: var(--accent);
  font-size: 0.72rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ============ FAVORITE BUTTON ============ */
.fav-btn {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 8px;
  font-size: 1.2rem;
  cursor: pointer;
  opacity: 0.7;
  transition: all 0.2s;
  padding: 0.3rem 0.45rem;
  z-index: 2;
  color: var(--text-muted);
  line-height: 1;
}
.fav-btn:hover { opacity: 1; transform: scale(1.1); background: rgba(255,217,61,0.12); border-color: rgba(255,217,61,0.3); }
.fav-btn.favorited { opacity: 1; background: rgba(255,217,61,0.15); border-color: rgba(255,217,61,0.35); animation: favPop 0.3s ease; }

@keyframes favPop {
  0% { transform: scale(1); }
  50% { transform: scale(1.4); }
  100% { transform: scale(1); }
}

/* ============ INLINE TIMER ============ */
.inline-timer {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  background: rgba(255,107,107,0.1);
  border: 1px solid rgba(255,107,107,0.2);
  border-radius: 999px;
  padding: 0.3rem 0.75rem;
  margin-top: 0.75rem;
  font-size: 0.82rem;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
}
.inline-timer:hover { background: rgba(255,107,107,0.2); }
.inline-timer.running { background: rgba(107,203,119,0.15); border-color: rgba(107,203,119,0.3); color: #6BCB77; }
.inline-timer .timer-display { font-variant-numeric: tabular-nums; min-width: 3.5rem; }

/* ============ GRID SECTION ============ */
.solve-it-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin: 1.5rem 0;
}

.grid-quad {
  border-radius: 14px;
  padding: 1.5rem;
  position: relative;
  overflow: hidden;
}

.grid-quad::before {
  content: '';
  position: absolute;
  inset: 0;
  background: inherit;
  opacity: 0.12;
  border-radius: inherit;
}

.grid-quad h3 {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.15rem;
  position: relative;
  z-index: 1;
  margin-bottom: 0.5rem;
}

.grid-quad p, .grid-quad li {
  position: relative;
  z-index: 1;
  font-size: 0.88rem;
  line-height: 1.55;
  color: var(--text-muted);
}

.grid-quad ul { list-style: none; padding: 0; }
.grid-quad li { padding: 0.2rem 0 0.2rem 1.2rem; position: relative; }
.grid-quad li::before { content: '‚Ä¢'; position: absolute; left: 0; }

.q-red { background: rgba(232,68,58,0.12); border: 1px solid rgba(232,68,58,0.2); }
.q-red h3 { color: var(--red); }
.q-red li::before { color: var(--red); }
.q-yellow { background: rgba(245,166,35,0.12); border: 1px solid rgba(245,166,35,0.2); }
.q-yellow h3 { color: var(--yellow); }
.q-yellow li::before { color: var(--yellow); }
.q-blue { background: rgba(74,144,217,0.12); border: 1px solid rgba(74,144,217,0.2); }
.q-blue h3 { color: var(--blue); }
.q-blue li::before { color: var(--blue); }
.q-green { background: rgba(92,184,92,0.12); border: 1px solid rgba(92,184,92,0.2); }
.q-green h3 { color: var(--green); }
.q-green li::before { color: var(--green); }

/* ============ LADDER ============ */
.ladder {
  display: flex;
  flex-direction: column;
  gap: 0;
  margin: 1.5rem 0;
}

.ladder-rung {
  padding: 1.25rem 1.5rem;
  border-left: 4px solid;
  background: var(--card-bg);
  cursor: pointer;
  transition: background 0.2s;
}

.ladder-rung:first-child { border-radius: 14px 14px 0 0; }
.ladder-rung:last-child { border-radius: 0 0 14px 14px; }
.ladder-rung:hover { background: var(--card-hover); }

.ladder-rung h4 {
  font-family: 'Fredoka', sans-serif;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

.ladder-rung .detail {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s;
}

.ladder-rung.open .detail { max-height: 600px; }

.ladder-rung .detail p {
  margin-top: 0.5rem;
  font-size: 0.88rem;
  color: var(--text-muted);
  line-height: 1.6;
}

.l1 { border-color: #6BCB77; } .l1 h4 { color: #6BCB77; }
.l2 { border-color: #4ECDC4; } .l2 h4 { color: #4ECDC4; }
.l3 { border-color: #F5A623; } .l3 h4 { color: #F5A623; }
.l4 { border-color: #E8443A; } .l4 h4 { color: #E8443A; }
.l5 { border-color: #8E3B5E; } .l5 h4 { color: #C06080; }

/* ============ SEARCH ============ */
.search-box {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}

.search-box input {
  flex: 1;
  padding: 0.75rem 1.25rem;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.1);
  background: var(--card-bg);
  color: var(--text-main);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  outline: none;
}

.search-box input:focus { border-color: var(--accent); }
.search-box input::placeholder { color: var(--text-muted); }

/* ============ CATEGORY FILTER ============ */
.filter-bar {
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
}

.filter-chip {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  padding: 0.35rem 0.8rem;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.08);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s;
}

.filter-chip:hover { background: rgba(255,255,255,0.06); }
.filter-chip.active { background: var(--purple); color: #fff; border-color: var(--purple); }

/* ============ FOOTER ============ */
.footer {
  text-align: center;
  padding: 3rem 1rem;
  color: #555;
  font-size: 0.8rem;
  border-top: 1px solid rgba(255,255,255,0.04);
  margin-top: 2rem;
}

/* ============ SECTION VISIBILITY ============ */
.page { display: none; }
.page.active { display: block; animation: pageFadeIn 0.25s ease; }

@keyframes pageFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ============ RESPONSIVE ============ */
@media (max-width: 700px) {
  .solve-it-grid { grid-template-columns: 1fr; }
  .hero { padding: 2.5rem 1.25rem 2rem; }
  .container { padding: 1.5rem 1rem 3rem; }
  .myday-timeline { padding-left: 0.5rem; }
  .sos-modal-content { width: 95%; margin: 1rem; padding: 1.5rem; }
  .quiz-card { padding: 1.5rem; }
}

/* =================================================================
   NEW FEATURES
   ================================================================= */

/* ============ SOS PANIC BUTTON ============ */
.sos-fab {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  z-index: 9999;
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: linear-gradient(135deg, #E8443A, #C0392B);
  border: none;
  color: #fff;
  font-size: 1.6rem;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(232,68,58,0.4), 0 0 40px rgba(232,68,58,0.15);
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: sosPulse 3s ease-in-out infinite;
}

.sos-fab:hover { transform: scale(1.1); box-shadow: 0 6px 30px rgba(232,68,58,0.6); }

@keyframes sosPulse {
  0%, 100% { box-shadow: 0 4px 20px rgba(232,68,58,0.4), 0 0 40px rgba(232,68,58,0.15); }
  50% { box-shadow: 0 4px 20px rgba(232,68,58,0.5), 0 0 60px rgba(232,68,58,0.25); }
}

.sos-fab-label {
  position: fixed;
  bottom: 2.7rem;
  right: 5.5rem;
  z-index: 9999;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--accent);
  background: var(--card-bg);
  padding: 0.35rem 0.75rem;
  border-radius: 8px;
  border: 1px solid rgba(255,107,107,0.2);
  pointer-events: none;
  opacity: 0;
  transform: translateX(8px);
  transition: all 0.3s;
}

.sos-fab:hover + .sos-fab-label { opacity: 1; transform: translateX(0); }

/* SOS Modal */
.sos-overlay {
  position: fixed;
  inset: 0;
  z-index: 10000;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease;
}
.sos-overlay.open { display: flex; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.sos-modal-content {
  background: var(--dark);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 20px;
  padding: 2rem;
  max-width: 520px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}

.sos-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.25rem;
  line-height: 1;
}

.sos-title {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--accent);
}

.sos-subtitle {
  color: var(--text-muted);
  font-size: 0.92rem;
  margin-bottom: 1.5rem;
  line-height: 1.5;
}

.sos-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.sos-option {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 14px;
  padding: 1.1rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.sos-option:hover {
  background: var(--card-hover);
  transform: translateY(-2px);
  border-color: rgba(255,255,255,0.12);
}

.sos-option .sos-emoji { font-size: 1.8rem; margin-bottom: 0.4rem; }
.sos-option .sos-label { font-family: 'Fredoka', sans-serif; font-size: 0.95rem; font-weight: 600; }

/* SOS Action Panel */
.sos-action {
  display: none;
  animation: fadeSlideUp 0.3s ease;
}
.sos-action.visible { display: block; }

@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.sos-action-title {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
}

.sos-step {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 1rem 1.25rem;
  margin-bottom: 0.6rem;
  font-size: 0.92rem;
  color: var(--text-muted);
  line-height: 1.55;
  border-left: 3px solid var(--accent);
}

.sos-step strong { color: var(--text-main); }

.sos-breathe {
  text-align: center;
  padding: 2rem;
  margin: 1rem 0;
}

.sos-breathe-circle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(107,203,119,0.3), rgba(107,203,119,0.05));
  border: 2px solid rgba(107,203,119,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1rem;
  font-family: 'Fredoka', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  color: #6BCB77;
  animation: breathe 8s ease-in-out infinite;
}

@keyframes breathe {
  0%, 100% { transform: scale(1); opacity: 0.7; }
  12.5% { transform: scale(1.25); opacity: 1; }
  50% { transform: scale(1.25); opacity: 1; }
  62.5% { transform: scale(1); opacity: 0.7; }
}

.sos-breathe-text {
  font-size: 0.88rem;
  color: var(--text-muted);
}

.sos-back {
  background: none;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 999px;
  padding: 0.5rem 1.2rem;
  color: var(--text-muted);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  cursor: pointer;
  margin-top: 0.75rem;
  transition: all 0.2s;
}
.sos-back:hover { background: rgba(255,255,255,0.06); color: var(--text-main); }

/* ============ MY DAY PLANNER ============ */
.myday-section { margin-bottom: 2rem; }

.myday-section-title {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.myday-section-subtitle {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 1rem;
  line-height: 1.5;
}

/* Brain Dump Input */
.braindump-input-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.braindump-input {
  flex: 1;
  padding: 0.75rem 1.25rem;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.1);
  background: var(--card-bg);
  color: var(--text-main);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  outline: none;
  transition: border-color 0.2s;
}
.braindump-input:focus { border-color: var(--accent); }
.braindump-input::placeholder { color: var(--text-muted); }

.braindump-add {
  padding: 0.75rem 1.25rem;
  border-radius: 14px;
  border: none;
  background: var(--accent);
  color: #fff;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.braindump-add:hover { background: #ff5252; transform: translateY(-1px); }

/* Task Items */
.task-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  min-height: 60px;
}

.task-item {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  animation: cardFadeIn 0.2s ease;
  transition: all 0.2s;
}

.task-item:hover { background: var(--card-hover); }

.task-done-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.15);
  background: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
  font-size: 0.75rem;
  color: transparent;
}

.task-item.completed .task-done-btn {
  border-color: #6BCB77;
  background: #6BCB77;
  color: #fff;
}

.task-item.completed .task-text {
  text-decoration: line-through;
  opacity: 0.5;
}

.task-text {
  flex: 1;
  font-size: 0.92rem;
  color: var(--text-main);
}

.task-color-btns {
  display: flex;
  gap: 0.25rem;
}

.task-color-btn {
  width: 22px;
  height: 22px;
  border-radius: 6px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.15s;
  opacity: 0.4;
}
.task-color-btn:hover { opacity: 0.8; transform: scale(1.15); }
.task-color-btn.selected { opacity: 1; border-color: #fff; transform: scale(1.1); }

.task-color-btn.tc-red { background: var(--red); }
.task-color-btn.tc-yellow { background: var(--yellow); }
.task-color-btn.tc-blue { background: var(--blue); }
.task-color-btn.tc-green { background: var(--green); }

.task-delete {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 1rem;
  opacity: 0.4;
  transition: all 0.15s;
  padding: 0.25rem;
}
.task-delete:hover { opacity: 1; color: var(--red); }

/* Task color indicator stripe */
.task-item[data-color="red"] { border-left: 3px solid var(--red); }
.task-item[data-color="yellow"] { border-left: 3px solid var(--yellow); }
.task-item[data-color="blue"] { border-left: 3px solid var(--blue); }
.task-item[data-color="green"] { border-left: 3px solid var(--green); }

/* Energy Meter */
.energy-meter {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 16px;
  padding: 1.25rem 1.5rem;
  margin: 1.5rem 0;
}

.energy-meter-title {
  font-family: 'Fredoka', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.energy-bar-row {
  display: flex;
  gap: 0.4rem;
  margin-bottom: 0.75rem;
  height: 28px;
  border-radius: 8px;
  overflow: hidden;
  background: rgba(255,255,255,0.03);
}

.energy-segment {
  height: 100%;
  transition: width 0.4s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
  color: rgba(255,255,255,0.8);
  min-width: 0;
  overflow: hidden;
}

.energy-segment.seg-red { background: var(--red); }
.energy-segment.seg-yellow { background: var(--yellow); }
.energy-segment.seg-blue { background: var(--blue); }
.energy-segment.seg-green { background: var(--green); }

.energy-legend {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-bottom: 0.75rem;
}

.energy-legend-item {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.energy-legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 3px;
  flex-shrink: 0;
}

.energy-nudge {
  font-size: 0.88rem;
  color: var(--text-muted);
  line-height: 1.55;
  padding: 0.75rem 1rem;
  background: rgba(255,107,107,0.06);
  border-radius: 10px;
  border-left: 3px solid var(--accent);
}

.energy-nudge.positive {
  background: rgba(107,203,119,0.06);
  border-left-color: #6BCB77;
}

/* My Day Stats */
.myday-stats {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.myday-stat {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 0.85rem 1.1rem;
  flex: 1;
  min-width: 100px;
  text-align: center;
}

.myday-stat-num {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.5rem;
  font-weight: 700;
}

.myday-stat-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.15rem;
}

/* My Day buttons */
.myday-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 1rem;
}

.myday-action-btn {
  padding: 0.5rem 1rem;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.1);
  background: transparent;
  color: var(--text-muted);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.myday-action-btn:hover { background: rgba(255,255,255,0.06); color: var(--text-main); }
.myday-action-btn.destructive:hover { background: rgba(232,68,58,0.15); color: var(--red); border-color: rgba(232,68,58,0.3); }

/* Local storage note */
.storage-note {
  font-size: 0.78rem;
  color: #555;
  text-align: center;
  margin-top: 1.5rem;
  font-style: italic;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 2.5rem 1rem;
  color: var(--text-muted);
}
.empty-state-emoji { font-size: 2.5rem; margin-bottom: 0.75rem; }
.empty-state-text { font-size: 0.95rem; line-height: 1.55; }

/* ============ QUIZ ============ */
.quiz-card {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 20px;
  padding: 2rem;
  max-width: 640px;
  margin: 0 auto;
}

.quiz-progress {
  display: flex;
  gap: 0.3rem;
  margin-bottom: 1.75rem;
}

.quiz-dot {
  flex: 1;
  height: 4px;
  border-radius: 4px;
  background: rgba(255,255,255,0.08);
  transition: background 0.3s;
}
.quiz-dot.filled { background: var(--accent); }

.quiz-question {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 1.25rem;
  line-height: 1.4;
}

.quiz-answers {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.quiz-answer {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 0.85rem 1.25rem;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.92rem;
  color: var(--text-muted);
  transition: all 0.2s;
  text-align: left;
}

.quiz-answer:hover { background: rgba(255,255,255,0.06); color: var(--text-main); border-color: rgba(255,255,255,0.15); }
.quiz-answer.selected { background: rgba(255,107,107,0.1); border-color: var(--accent); color: var(--text-main); }

/* Quiz Result */
.quiz-result {
  text-align: center;
  animation: fadeSlideUp 0.4s ease;
}

.quiz-result-icon { font-size: 3rem; margin-bottom: 0.75rem; }

.quiz-result h3 {
  font-family: 'Fredoka', sans-serif;
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.quiz-result p {
  color: var(--text-muted);
  font-size: 0.92rem;
  line-height: 1.55;
  margin-bottom: 1rem;
}

.quiz-result-strategies {
  text-align: left;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 14px;
  padding: 1.25rem;
  margin: 1rem 0;
}

.quiz-result-strategies h4 {
  font-family: 'Fredoka', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.6rem;
  color: var(--accent);
}

.quiz-result-strategies li {
  color: var(--text-muted);
  font-size: 0.88rem;
  line-height: 1.55;
  padding: 0.3rem 0 0.3rem 1.4rem;
  position: relative;
  list-style: none;
}

.quiz-result-strategies li::before {
  content: '‚Üí';
  position: absolute;
  left: 0;
  color: var(--accent);
}

.quiz-restart {
  margin-top: 1rem;
  padding: 0.6rem 1.5rem;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.1);
  background: transparent;
  color: var(--text-muted);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.quiz-restart:hover { background: rgba(255,255,255,0.06); color: var(--text-main); }

.quiz-go-btn {
  padding: 0.6rem 1.5rem;
  border-radius: 999px;
  border: none;
  background: var(--accent);
  color: #fff;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 0.5rem;
}
.quiz-go-btn:hover { background: #ff5252; }

/* ============ LADDER TRACKER ============ */
.ladder-checkin {
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 16px;
  padding: 1.25rem 1.5rem;
  margin-bottom: 1.5rem;
}

.ladder-checkin-title {
  font-family: 'Fredoka', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.ladder-checkin-subtitle {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 1rem;
}

.ladder-checkin-btns {
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
}

.ladder-checkin-btn {
  padding: 0.5rem 1rem;
  border-radius: 999px;
  border: 2px solid;
  background: transparent;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.ladder-checkin-btn:hover { transform: translateY(-1px); }

.ladder-checkin-btn.lcb-1 { border-color: #6BCB77; color: #6BCB77; }
.ladder-checkin-btn.lcb-1:hover, .ladder-checkin-btn.lcb-1.today-active { background: rgba(107,203,119,0.15); }
.ladder-checkin-btn.lcb-2 { border-color: #4ECDC4; color: #4ECDC4; }
.ladder-checkin-btn.lcb-2:hover, .ladder-checkin-btn.lcb-2.today-active { background: rgba(78,205,196,0.15); }
.ladder-checkin-btn.lcb-3 { border-color: #F5A623; color: #F5A623; }
.ladder-checkin-btn.lcb-3:hover, .ladder-checkin-btn.lcb-3.today-active { background: rgba(245,166,35,0.15); }
.ladder-checkin-btn.lcb-4 { border-color: #E8443A; color: #E8443A; }
.ladder-checkin-btn.lcb-4:hover, .ladder-checkin-btn.lcb-4.today-active { background: rgba(232,68,58,0.15); }
.ladder-checkin-btn.lcb-5 { border-color: #C06080; color: #C06080; }
.ladder-checkin-btn.lcb-5:hover, .ladder-checkin-btn.lcb-5.today-active { background: rgba(192,96,128,0.15); }

.ladder-history {
  margin-top: 1rem;
}

.ladder-history-title {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.ladder-history-row {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
}

.ladder-history-dot {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.65rem;
  font-weight: 700;
  color: rgba(255,255,255,0.7);
  position: relative;
}

.ladder-history-dot[title]::after {
  content: attr(title);
}

.lhd-1 { background: rgba(107,203,119,0.25); }
.lhd-2 { background: rgba(78,205,196,0.25); }
.lhd-3 { background: rgba(245,166,35,0.25); }
.lhd-4 { background: rgba(232,68,58,0.25); }
.lhd-5 { background: rgba(192,96,128,0.25); }
.lhd-empty { background: rgba(255,255,255,0.03); }

/* ============ MY TOOLS (FAVORITES) TAB ============ */
.fav-empty {
  text-align: center;
  padding: 3rem 1rem;
}

.fav-empty-emoji { font-size: 3rem; margin-bottom: 0.75rem; }

.fav-empty-text {
  color: var(--text-muted);
  font-size: 0.95rem;
  line-height: 1.55;
  max-width: 400px;
  margin: 0 auto;
}

/* ============ LANGUAGE PICKER ============ */
.lang-picker {
  position: absolute;
  top: 1rem;
  right: 1.5rem;
  z-index: 101;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  background: rgba(20, 20, 31, 0.6);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 999px;
  padding: 0.2rem 0.8rem 0.2rem 0.6rem;
  transition: all 0.2s;
}
.lang-picker:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.2); }
.lang-icon { font-size: 0.9rem; opacity: 0.8; }
.lang-picker select {
  background: transparent; color: var(--text-muted);
  font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 600;
  border: none; outline: none; cursor: pointer;
  appearance: none; -webkit-appearance: none; padding-right: 10px;
}
.lang-picker select:hover, .lang-picker select:focus { color: var(--text-main); }
.lang-picker select option { background: var(--darker); color: var(--text-main); }

</style>
</head>
<body>

<!-- SOS FLOATING BUTTON -->
<button class="sos-fab" onclick="openSOS()" data-i18n-aria="ui.sosFabAriaLabel">üÜò</button>
<div class="sos-fab-label" data-i18n="ui.sosFabLabel"></div>

<!-- SOS MODAL -->
<div class="sos-overlay" id="sosOverlay" onclick="if(event.target===this)closeSOS()">
  <div class="sos-modal-content" id="sosModalContent">
    <!-- Rendered by renderSOSModal() -->
  </div>
</div>

<!-- HERO -->
<div class="hero">
  <div class="lang-picker">
    <span class="lang-icon">üåç</span>
    <select id="langSelect" onchange="setLanguage(this.value)" aria-label="Select Language">
      <option value="en">English</option>
      <option value="pt">Portugu√™s</option>
      <option value="es">Espa√±ol</option>
    </select>
  </div>
  <h1 data-i18n="ui.heroTitle"></h1>
  <p class="subtitle" data-i18n="ui.heroSubtitle"></p>
  <p class="source-note" data-i18n="ui.heroSource"></p>
</div>

<!-- NAV -->
<div class="nav-bar">
  <button class="nav-btn active" data-page="traits" data-i18n="ui.navTraits"></button>
  <button class="nav-btn" data-page="grid" data-i18n="ui.navGrid"></button>
  <button class="nav-btn" data-page="ladder" data-i18n="ui.navLadder"></button>
  <button class="nav-btn" data-page="patterns" data-i18n="ui.navPatterns"></button>
  <button class="nav-btn" data-page="cbt" data-i18n="ui.navCbt"></button>
  <button class="nav-btn" data-page="naming" data-i18n="ui.navNaming"></button>
  <button class="nav-btn" data-page="quiz" data-i18n="ui.navQuiz"></button>
  <button class="nav-btn nav-myday" data-page="myday" data-i18n="ui.navMyday"></button>
  <button class="nav-btn nav-fav" data-page="favs" data-i18n="ui.navFavs"></button>
</div>

<!-- MAIN CONTENT -->
<div class="container">

<!-- ==================== PAGE: TRAITS & TOOLS ==================== -->
<div class="page active" id="page-traits">
  <div class="section-header">
    <h2 data-i18n="ui.traitsTitle"></h2>
    <p data-i18n="ui.traitsDesc"></p>
  </div>

  <div class="search-box">
    <input type="text" id="traitSearch" data-i18n-placeholder="ui.searchPlaceholder" oninput="filterTraits()">
  </div>

  <div class="filter-bar" id="categoryFilter"></div>
  <div class="trait-grid" id="traitGrid"></div>
</div>

<!-- ==================== PAGE: SOLVE-IT GRID ==================== -->
<div class="page" id="page-grid">
  <div class="section-header">
    <h2 data-i18n="ui.gridTitle"></h2>
    <p data-i18n="ui.gridDesc"></p>
  </div>

  <div id="gridContent"></div>
</div>

<!-- ==================== PAGE: EMOTIONAL LADDER ==================== -->
<div class="page" id="page-ladder">
  <div class="section-header">
    <h2 data-i18n="ui.ladderTitle"></h2>
    <p data-i18n="ui.ladderDesc"></p>
  </div>

  <div id="ladderContent"></div>
</div>

<!-- ==================== PAGE: PATTERNS ==================== -->
<div class="page" id="page-patterns">
  <div class="section-header">
    <h2 data-i18n="ui.patternsTitle"></h2>
    <p data-i18n="ui.patternsDesc"></p>
  </div>

  <div class="trait-grid" id="patternGrid"></div>
</div>

<!-- ==================== PAGE: CBT TOOLKIT ==================== -->
<div class="page" id="page-cbt">
  <div class="section-header">
    <h2 data-i18n="ui.cbtTitle"></h2>
    <p data-i18n="ui.cbtDesc"></p>
  </div>

  <div class="trait-grid" id="cbtGrid"></div>
</div>

<!-- ==================== PAGE: NAME YOUR ADHD ==================== -->
<div class="page" id="page-naming">
  <div class="section-header">
    <h2 data-i18n="ui.namingTitle"></h2>
    <p data-i18n="ui.namingDesc"></p>
  </div>

  <div id="namingContent"></div>
</div>

<!-- ==================== PAGE: QUIZ ==================== -->
<div class="page" id="page-quiz">
  <div class="section-header">
    <h2 data-i18n="ui.quizTitle"></h2>
    <p data-i18n="ui.quizDesc"></p>
  </div>

  <div class="quiz-card" id="quizCard"></div>
</div>

<!-- ==================== PAGE: MY DAY ==================== -->
<div class="page" id="page-myday">
  <div class="section-header">
    <h2 data-i18n="ui.mydayTitle"></h2>
    <p data-i18n="ui.mydayDesc"></p>
  </div>

  <!-- Stats -->
  <div class="myday-stats" id="mydayStats">
    <div class="myday-stat">
      <div class="myday-stat-num" id="statTotal">0</div>
      <div class="myday-stat-label" data-i18n="ui.statTasks"></div>
    </div>
    <div class="myday-stat">
      <div class="myday-stat-num" id="statDone" style="color:#6BCB77">0</div>
      <div class="myday-stat-label" data-i18n="ui.statDone"></div>
    </div>
    <div class="myday-stat">
      <div class="myday-stat-num" id="statStreak" style="color:#FFD93D">0</div>
      <div class="myday-stat-label" data-i18n="ui.statDayStreak"></div>
    </div>
  </div>

  <!-- Energy Meter -->
  <div class="energy-meter" id="energyMeter">
    <div class="energy-meter-title" data-i18n="ui.energyTitle"></div>
    <div class="energy-bar-row" id="energyBar"></div>
    <div class="energy-legend" id="energyLegend"></div>
    <div class="energy-nudge" id="energyNudge"></div>
  </div>

  <!-- Brain Dump -->
  <div class="myday-section">
    <div class="myday-section-title" data-i18n="ui.brainDumpTitle"></div>
    <div class="myday-section-subtitle" data-i18n="ui.brainDumpSubtitle"></div>
    <div class="braindump-input-row">
      <input type="text" class="braindump-input" id="braindumpInput" data-i18n-placeholder="ui.brainDumpPlaceholder" onkeydown="if(event.key==='Enter')addTask()">
      <button class="braindump-add" onclick="addTask()" data-i18n="ui.brainDumpAddBtn"></button>
    </div>
    <div class="task-list" id="taskList"></div>
  </div>

  <!-- Actions -->
  <div class="myday-actions">
    <button class="myday-action-btn" onclick="carryForward()" data-i18n="ui.carryForwardBtn"></button>
    <button class="myday-action-btn destructive" onclick="clearDay()" data-i18n="ui.freshStartBtn"></button>
  </div>

  <div class="storage-note" data-i18n="ui.storageNote"></div>
</div>

<!-- ==================== PAGE: MY TOOLS (FAVORITES) ==================== -->
<div class="page" id="page-favs">
  <div class="section-header">
    <h2 data-i18n="ui.favsTitle"></h2>
    <p data-i18n="ui.favsDesc"></p>
  </div>

  <div id="favsContainer"></div>
</div>

</div><!-- /container -->

<div class="footer" data-i18n="ui.footer"></div>

<script src="locales/en.js"></script>
<script src="locales/pt.js"></script>
<script src="locales/es.js"></script>

<script>
// ============ GLOBAL STATE ============
let currentLang = langEN;
let traits = currentLang.traits;
let patterns = currentLang.patterns;
let cbtTools = currentLang.cbtTools;
let quizQuestions = currentLang.quizQuestions;
let patternResults = currentLang.patternResults;
let timerCounter = 0;
let activeTimers = {};
let quizStep = 0;
let quizScores = { speed: 0, fire: 0, blue: 0, redblue: 0 };

// ============ i18n ENGINE ============
function resolveKey(obj, key) {
  return key.split('.').reduce((o, k) => (o && o[k] !== undefined) ? o[k] : null, obj);
}

function setLanguage(langCode) {
  const langMap = { en: langEN, pt: langPT, es: langES };
  currentLang = langMap[langCode] || langEN;

  // Save preference
  localStorage.setItem('user-lang', langCode);

  // Sync select
  const sel = document.getElementById('langSelect');
  if (sel) sel.value = langCode;

  // Set html lang
  document.documentElement.lang = langCode;

  // Reassign data globals
  traits = currentLang.traits;
  patterns = currentLang.patterns;
  cbtTools = currentLang.cbtTools;
  quizQuestions = currentLang.quizQuestions;
  patternResults = currentLang.patternResults;

  // Update all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const val = resolveKey(currentLang, el.dataset.i18n);
    if (val !== null) el.innerHTML = val;
  });

  // Update placeholders
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const val = resolveKey(currentLang, el.dataset.i18nPlaceholder);
    if (val !== null) el.placeholder = val;
  });

  // Update aria-labels
  document.querySelectorAll('[data-i18n-aria]').forEach(el => {
    const val = resolveKey(currentLang, el.dataset.i18nAria);
    if (val !== null) el.setAttribute('aria-label', val);
  });

  // Re-render all dynamic sections
  renderFilterChips();
  renderSOSModal();
  renderGridPage();
  renderLadderPage();
  renderNamingPage();
  renderEnergyLegend();
  timerCounter = 0;
  document.getElementById('traitGrid').innerHTML = traits.map(renderTraitCard).join('');
  document.getElementById('patternGrid').innerHTML = patterns.map(renderPatternCard).join('');
  document.getElementById('cbtGrid').innerHTML = cbtTools.map(renderCBTCard).join('');
  renderFavorites();
  renderTasks();
  renderQuiz();
  renderLadderHistory();
}

// ============ INIT LANGUAGE ============
(function initLang() {
  const saved = localStorage.getItem('user-lang');
  const browser = (navigator.language || '').slice(0, 2);
  const supported = ['en', 'pt', 'es'];
  const lang = saved || (supported.includes(browser) ? browser : 'en');
  setLanguage(lang);
})();

// ============ RENDER FILTER CHIPS ============
function renderFilterChips() {
  const L = currentLang.ui;
  const chips = [
    { cat: 'all', label: L.filterAll },
    { cat: 'attention', label: L.filterAttention },
    { cat: 'emotion', label: L.filterEmotion },
    { cat: 'executive', label: L.filterExecutive },
    { cat: 'motivation', label: L.filterMotivation },
    { cat: 'thinking', label: L.filterThinking },
    { cat: 'social', label: L.filterSocial }
  ];
  document.getElementById('categoryFilter').innerHTML = chips.map((c, i) =>
    `<button class="filter-chip ${i===0?'active':''}" data-cat="${c.cat}">${c.label}</button>`
  ).join('');
  // Re-attach event listeners
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      const cat = chip.dataset.cat;
      document.querySelectorAll('#traitGrid .trait-card').forEach(card => {
        card.style.display = (cat === 'all' || card.dataset.cat === cat) ? '' : 'none';
      });
    });
  });
}

// ============ RENDER SOS MODAL ============
function renderSOSModal() {
  const L = currentLang.ui;
  const sosKeys = ['spiraling','paralyzed','avoiding','overwhelmed','emotional','shame'];

  // Build options grid
  let optionsHTML = '<div class="sos-options">';
  sosKeys.forEach(key => {
    optionsHTML += `<div class="sos-option" onclick="showSOSAction('${key}')">
      <div class="sos-emoji">${L['sosOpt' + key.charAt(0).toUpperCase() + key.slice(1) + 'Emoji']}</div>
      <div class="sos-label">${L['sosOpt' + key.charAt(0).toUpperCase() + key.slice(1) + 'Label']}</div>
    </div>`;
  });
  optionsHTML += '</div>';

  // Build action panels
  let actionsHTML = '';
  sosKeys.forEach(key => {
    const data = L.sos[key];
    let breatheHTML = '';
    if (data.hasBreathe) {
      const breatheId = key === 'spiraling' ? ' id="breatheCircle"' : '';
      breatheHTML = `<div class="sos-breathe">
        <div class="sos-breathe-circle"${breatheId}>${data.breatheCircleText}</div>
        <div class="sos-breathe-text">${data.breatheSubtext}</div>
      </div>`;
    }
    const stepsHTML = data.steps.map(s => `<div class="sos-step">${s}</div>`).join('');
    actionsHTML += `<div class="sos-action" id="sos-${key}">
      <div class="sos-action-title" style="color:${data.titleColor}">${data.title}</div>
      ${breatheHTML}
      ${stepsHTML}
      <button class="sos-back" onclick="sosGoBack()">${L.sosBackBtn}</button>
    </div>`;
  });

  document.getElementById('sosModalContent').innerHTML = `
    <button class="sos-close" onclick="closeSOS()">${L.sosCloseLabel}</button>
    <div id="sosStep1" style="padding:2rem">
      <div class="sos-title">${L.sosTitle}</div>
      <div class="sos-subtitle">${L.sosSubtitle}</div>
      ${optionsHTML}
    </div>
    ${actionsHTML}
  `;
}

// ============ RENDER GRID PAGE ============
function renderGridPage() {
  const grid = currentLang.pages.grid;
  let html = '<div class="solve-it-grid">';
  grid.quadrants.forEach(q => {
    html += `<div class="grid-quad ${q.cssClass}">
      <h3>${q.title}</h3>
      <p>${q.subtitle}</p>
      <p style="margin:0.5rem 0">${q.body}</p>
      <p>${q.examples}</p>
      <p style="margin-top:0.5rem">${q.battery}</p>
      <ul style="margin-top:0.5rem">${q.strategies.map(s => `<li>${s}</li>`).join('')}</ul>
    </div>`;
  });
  html += '</div>';

  html += `<div class="tool-card" style="margin-top:1.5rem">
    <h4>${grid.quickPractice.title}</h4>
    <ol class="steps">${grid.quickPractice.steps.map(s => `<li>${s}</li>`).join('')}</ol>
  </div>`;

  document.getElementById('gridContent').innerHTML = html;
}

// ============ RENDER LADDER PAGE ============
function renderLadderPage() {
  const L = currentLang.ui;
  const ladder = currentLang.pages.ladder;

  let html = `<div class="ladder-checkin">
    <div class="ladder-checkin-title">${L.ladderCheckinTitle}</div>
    <div class="ladder-checkin-subtitle">${L.ladderCheckinSubtitle}</div>
    <div class="ladder-checkin-btns">
      <button class="ladder-checkin-btn lcb-1" onclick="logLadder(1)">${L.ladderCheckinBtn1}</button>
      <button class="ladder-checkin-btn lcb-2" onclick="logLadder(2)">${L.ladderCheckinBtn2}</button>
      <button class="ladder-checkin-btn lcb-3" onclick="logLadder(3)">${L.ladderCheckinBtn3}</button>
      <button class="ladder-checkin-btn lcb-4" onclick="logLadder(4)">${L.ladderCheckinBtn4}</button>
      <button class="ladder-checkin-btn lcb-5" onclick="logLadder(5)">${L.ladderCheckinBtn5}</button>
    </div>
    <div class="ladder-history" id="ladderHistory"></div>
  </div>`;

  html += '<div class="ladder">';
  ladder.rungs.forEach(r => {
    html += `<div class="ladder-rung ${r.cssClass}" onclick="this.classList.toggle('open')">
      <h4>${r.title}</h4>
      <div class="detail">${r.detail}</div>
    </div>`;
  });
  html += '</div>';

  document.getElementById('ladderContent').innerHTML = html;
  renderLadderHistory();
}

// ============ RENDER NAMING PAGE ============
function renderNamingPage() {
  const naming = currentLang.pages.naming;

  let html = `<div class="tool-card" style="margin-bottom:1.5rem">
    <h4>${naming.scienceCard.title}</h4>
    <p style="color:var(--text-muted);font-size:0.9rem;line-height:1.6;margin-top:0.5rem">${naming.scienceCard.content}</p>
  </div>`;

  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-bottom:2rem">';
  naming.metaphors.forEach(m => {
    html += `<div class="tool-card">
      <h4>${m.title}</h4>
      <p style="color:var(--text-muted);font-size:0.88rem;line-height:1.5;margin-top:0.4rem">${m.content}</p>
    </div>`;
  });
  html += `<div class="tool-card" style="background:rgba(255,107,107,0.08);border-color:rgba(255,107,107,0.2)">
    <h4>${naming.createOwn.title}</h4>
    <p style="color:var(--text-muted);font-size:0.88rem;line-height:1.5;margin-top:0.4rem">${naming.createOwn.content}</p>
  </div>`;
  html += '</div>';

  document.getElementById('namingContent').innerHTML = html;
}

// ============ RENDER ENERGY LEGEND ============
function renderEnergyLegend() {
  const L = currentLang.ui;
  document.getElementById('energyLegend').innerHTML = `
    <div class="energy-legend-item"><div class="energy-legend-dot" style="background:var(--red)"></div>${L.energyRedLabel}</div>
    <div class="energy-legend-item"><div class="energy-legend-dot" style="background:var(--yellow)"></div>${L.energyYellowLabel}</div>
    <div class="energy-legend-item"><div class="energy-legend-dot" style="background:var(--blue)"></div>${L.energyBlueLabel}</div>
    <div class="energy-legend-item"><div class="energy-legend-dot" style="background:var(--green)"></div>${L.energyGreenLabel}</div>
  `;
}

// ============ RENDER TRAIT CARD ============
function renderTraitCard(t) {
  const L = currentLang.ui;
  const favs = getFavorites();
  const searchText = `${t.title} ${t.aka} ${t.what} ${t.feel} ${t.tools.map(x => x.name + ' ' + x.steps.join(' ')).join(' ')}`.toLowerCase();

  const toolsHTML = t.tools.map((tool, i) => {
    const favId = `${t.id}-tool-${i}`;
    const isFav = favs.includes(favId);
    const timerId = `timer-${timerCounter++}`;
    const timerHTML = tool.hasTimer ? `<div class="inline-timer" data-timer-id="${timerId}" onclick="startTimer(this, ${tool.timerSec})">‚è± <span class="timer-display">${formatTime(tool.timerSec)}</span> ${L.timerTapToStart}</div>` : '';
    return `
    <div class="tool-card">
      <button class="fav-btn ${isFav?'favorited':''}" data-fav-id="${favId}" onclick="event.stopPropagation();toggleFavorite('${favId}')">${isFav?'‚≠ê':'<span style="color:#9595B0;font-size:1.1rem">‚ú©</span>'}</button>
      <h4>üîß ${tool.name}</h4>
      <ol class="steps">${tool.steps.map(s => `<li>${s}</li>`).join('')}</ol>
      ${timerHTML}
    </div>
  `}).join('');

  return `
    <div class="trait-card" data-cat="${t.cat}" data-search="${searchText}">
      <div class="trait-header" onclick="this.parentElement.classList.toggle('open')">
        <div class="trait-icon" style="background:${t.color}22;color:${t.color}">${t.icon}</div>
        <div class="trait-title-group">
          <h3 style="color:${t.color}">${t.title}</h3>
          <div class="aka">${t.aka}</div>
        </div>
        <div class="expand-arrow">‚ñº</div>
      </div>
      <div class="trait-body">
        <div class="trait-content">
          <div class="trait-section">
            <div class="trait-section-label label-what">${L.labelWhatItIs}</div>
            <p>${t.what}</p>
          </div>
          <div class="trait-section">
            <div class="trait-section-label label-feel">${L.labelHowItFeels}</div>
            <p>${t.feel}</p>
          </div>
          <div class="trait-section">
            <div class="trait-section-label label-tool">${L.labelTools}</div>
            ${toolsHTML}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============ RENDER PATTERN CARD ============
function renderPatternCard(p) {
  const L = currentLang.ui;
  return `
    <div class="trait-card">
      <div class="trait-header" onclick="this.parentElement.classList.toggle('open')">
        <div class="trait-icon" style="background:${p.color}22;color:${p.color}">${p.icon}</div>
        <div class="trait-title-group">
          <h3 style="color:${p.color}">${p.title}</h3>
          <div class="aka">${p.aka}</div>
        </div>
        <div class="expand-arrow">‚ñº</div>
      </div>
      <div class="trait-body">
        <div class="trait-content">
          <div class="trait-section">
            <div class="trait-section-label label-what">${L.labelThePattern}</div>
            <p>${p.what}</p>
          </div>
          <div class="trait-section">
            <div class="trait-section-label label-tool">${L.labelStrategies}</div>
            <ul>${p.strategies.map(s => `<li>${s}</li>`).join('')}</ul>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============ RENDER CBT CARD ============
function renderCBTCard(c) {
  const L = currentLang.ui;
  const favs = getFavorites();
  const toolsHTML = c.tools.map((tool, i) => {
    const favId = `cbt-${c.title.replace(/\s+/g,'-').toLowerCase()}-tool-${i}`;
    const isFav = favs.includes(favId);
    const timerId = `timer-${timerCounter++}`;
    const timerHTML = tool.hasTimer ? `<div class="inline-timer" data-timer-id="${timerId}" onclick="startTimer(this, ${tool.timerSec})">‚è± <span class="timer-display">${formatTime(tool.timerSec)}</span> ${L.timerTapToStart}</div>` : '';
    return `
    <div class="tool-card">
      <button class="fav-btn ${isFav?'favorited':''}" data-fav-id="${favId}" onclick="event.stopPropagation();toggleFavorite('${favId}')">${isFav?'‚≠ê':'<span style="color:#9595B0;font-size:1.1rem">‚ú©</span>'}</button>
      <h4>üîß ${tool.name}</h4>
      <ol class="steps">${tool.steps.map(s => `<li>${s}</li>`).join('')}</ol>
      ${timerHTML}
    </div>
  `}).join('');

  return `
    <div class="trait-card">
      <div class="trait-header" onclick="this.parentElement.classList.toggle('open')">
        <div class="trait-icon" style="background:${c.color}22;color:${c.color}">${c.icon}</div>
        <div class="trait-title-group">
          <h3 style="color:${c.color}">${c.title}</h3>
          <div class="aka">${c.aka}</div>
        </div>
        <div class="expand-arrow">‚ñº</div>
      </div>
      <div class="trait-body">
        <div class="trait-content">
          <div class="trait-section">
            <div class="trait-section-label label-what">${L.labelWhatItIs}</div>
            <p>${c.what}</p>
          </div>
          <div class="trait-section">
            <div class="trait-section-label label-how">${L.labelHowToUse}</div>
            ${toolsHTML}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============ RENDER FAVORITES ============
function renderFavorites() {
  const L = currentLang.ui;
  const favs = getFavorites();
  const container = document.getElementById('favsContainer');
  if (!favs.length) {
    container.innerHTML = `<div class="fav-empty"><div class="fav-empty-emoji">${L.favEmptyEmoji}</div><div class="fav-empty-text">${L.favEmptyText}</div></div>`;
    return;
  }
  let html = '<div class="trait-grid">';
  // Find matching tools
  favs.forEach(favId => {
    // Check traits
    traits.forEach(t => {
      t.tools.forEach((tool, i) => {
        if (`${t.id}-tool-${i}` === favId) {
          const timerId = `timer-${timerCounter++}`;
          const timerHTML = tool.hasTimer ? `<div class="inline-timer" data-timer-id="${timerId}" onclick="startTimer(this, ${tool.timerSec})">‚è± <span class="timer-display">${formatTime(tool.timerSec)}</span> ${L.timerTapToStart}</div>` : '';
          html += `<div class="tool-card" style="border-left:3px solid ${t.color}">
            <button class="fav-btn favorited" data-fav-id="${favId}" onclick="toggleFavorite('${favId}')">‚≠ê</button>
            <h4>${t.icon} ${tool.name}</h4>
            <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.5rem">${L.favFromLabel} ${t.title}</div>
            <ol class="steps">${tool.steps.map(s => `<li>${s}</li>`).join('')}</ol>
            ${timerHTML}
          </div>`;
        }
      });
    });
    // Check CBT tools
    cbtTools.forEach(c => {
      c.tools.forEach((tool, i) => {
        const cbtId = `cbt-${c.title.replace(/\s+/g,'-').toLowerCase()}-tool-${i}`;
        if (cbtId === favId) {
          const timerId = `timer-${timerCounter++}`;
          const timerHTML = tool.hasTimer ? `<div class="inline-timer" data-timer-id="${timerId}" onclick="startTimer(this, ${tool.timerSec})">‚è± <span class="timer-display">${formatTime(tool.timerSec)}</span> ${L.timerTapToStart}</div>` : '';
          html += `<div class="tool-card" style="border-left:3px solid ${c.color}">
            <button class="fav-btn favorited" data-fav-id="${favId}" onclick="toggleFavorite('${favId}')">‚≠ê</button>
            <h4>${c.icon} ${tool.name}</h4>
            <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.5rem">${L.favFromLabel} ${c.title}</div>
            <ol class="steps">${tool.steps.map(s => `<li>${s}</li>`).join('')}</ol>
            ${timerHTML}
          </div>`;
        }
      });
    });
  });
  html += '</div>';
  container.innerHTML = html;
}

// Note: initial renders are handled by setLanguage() called from initLang()

// ============ NAV ============
function switchToPage(pageName) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const btn = document.querySelector(`.nav-btn[data-page="${pageName}"]`);
  if (btn) btn.classList.add('active');
  const page = document.getElementById('page-' + pageName);
  if (page) page.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', () => switchToPage(btn.dataset.page));
});

// ============ SEARCH ============
function filterTraits() {
  const query = document.getElementById('traitSearch').value.toLowerCase();
  document.querySelectorAll('#traitGrid .trait-card').forEach(card => {
    const match = card.dataset.search.includes(query);
    card.style.display = match ? '' : 'none';
  });
}

// ============ SOS SYSTEM ============
function openSOS() {
  document.getElementById('sosOverlay').classList.add('open');
  document.getElementById('sosStep1').style.display = 'block';
  document.querySelectorAll('.sos-action').forEach(a => a.classList.remove('visible'));
}
function closeSOS() { document.getElementById('sosOverlay').classList.remove('open'); }
function showSOSAction(type) {
  document.getElementById('sosStep1').style.display = 'none';
  document.getElementById('sos-' + type).classList.add('visible');
}
function sosGoBack() {
  document.querySelectorAll('.sos-action').forEach(a => a.classList.remove('visible'));
  document.getElementById('sosStep1').style.display = 'block';
}

// ============ MY DAY PLANNER ============
function getTodayKey() { return 'myday-' + new Date().toISOString().slice(0, 10); }
function getTasks() { try { return JSON.parse(localStorage.getItem(getTodayKey()) || '[]'); } catch { return []; } }
function saveTasks(tasks) { localStorage.setItem(getTodayKey(), JSON.stringify(tasks)); }

function addTask() {
  const input = document.getElementById('braindumpInput');
  const text = input.value.trim();
  if (!text) return;
  const tasks = getTasks();
  tasks.push({ id: Date.now(), text, color: null, done: false });
  saveTasks(tasks);
  input.value = '';
  renderTasks();
  input.focus();
}

function toggleTaskDone(id) {
  const tasks = getTasks();
  const task = tasks.find(t => t.id === id);
  if (task) { task.done = !task.done; saveTasks(tasks); renderTasks(); }
}

function setTaskColor(id, color) {
  const tasks = getTasks();
  const task = tasks.find(t => t.id === id);
  if (task) { task.color = task.color === color ? null : color; saveTasks(tasks); renderTasks(); }
}

function deleteTask(id) {
  let tasks = getTasks();
  tasks = tasks.filter(t => t.id !== id);
  saveTasks(tasks);
  renderTasks();
}

function renderTasks() {
  const L = currentLang.ui;
  const tasks = getTasks();
  const container = document.getElementById('taskList');
  if (!tasks.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-emoji">${L.taskEmptyEmoji}</div><div class="empty-state-text">${L.taskEmptyText}</div></div>`;
  } else {
    container.innerHTML = tasks.map(t => `
      <div class="task-item ${t.done?'completed':''}" data-color="${t.color||''}">
        <button class="task-done-btn" onclick="toggleTaskDone(${t.id})">${t.done?'‚úì':''}</button>
        <span class="task-text">${t.text}</span>
        <div class="task-color-btns">
          <div class="task-color-btn tc-red ${t.color==='red'?'selected':''}" title="${L.taskColorRedTitle}" onclick="setTaskColor(${t.id},'red')"></div>
          <div class="task-color-btn tc-yellow ${t.color==='yellow'?'selected':''}" title="${L.taskColorYellowTitle}" onclick="setTaskColor(${t.id},'yellow')"></div>
          <div class="task-color-btn tc-blue ${t.color==='blue'?'selected':''}" title="${L.taskColorBlueTitle}" onclick="setTaskColor(${t.id},'blue')"></div>
          <div class="task-color-btn tc-green ${t.color==='green'?'selected':''}" title="${L.taskColorGreenTitle}" onclick="setTaskColor(${t.id},'green')"></div>
        </div>
        <button class="task-delete" onclick="deleteTask(${t.id})">‚úï</button>
      </div>
    `).join('');
  }
  updateEnergyMeter(tasks);
  updateStats(tasks);
}

function updateEnergyMeter(tasks) {
  const L = currentLang.ui;
  const coloredTasks = tasks.filter(t => t.color);
  const bar = document.getElementById('energyBar');
  const nudge = document.getElementById('energyNudge');
  if (!coloredTasks.length) {
    bar.innerHTML = `<div style="flex:1;display:flex;align-items:center;justify-content:center;font-size:0.78rem;color:var(--text-muted)">${L.energyColorPrompt}</div>`;
    nudge.textContent = '';
    nudge.className = 'energy-nudge';
    nudge.style.display = 'none';
    return;
  }
  const counts = { red: 0, yellow: 0, blue: 0, green: 0 };
  coloredTasks.forEach(t => { if (counts[t.color] !== undefined) counts[t.color]++; });
  const total = coloredTasks.length;
  bar.innerHTML = ['red','yellow','blue','green'].map(c => {
    const pct = (counts[c] / total) * 100;
    return pct > 0 ? `<div class="energy-segment seg-${c}" style="width:${pct}%">${counts[c]}</div>` : '';
  }).join('');

  // Generate nudge
  nudge.style.display = 'block';
  const redPct = counts.red / total;
  const yellowPct = counts.yellow / total;
  const greenPct = counts.green / total;
  const bluePct = counts.blue / total;
  const drainPct = redPct + yellowPct;

  if (counts.green === 0 && counts.blue === 0 && total > 1) {
    nudge.className = 'energy-nudge'; nudge.innerHTML = L.nudgeAllDrain;
  } else if (redPct > 0.5) {
    nudge.className = 'energy-nudge'; nudge.innerHTML = L.nudgeHeavyRed;
  } else if (yellowPct > 0.6 && greenPct === 0) {
    nudge.className = 'energy-nudge'; nudge.innerHTML = L.nudgeYellowMarathon;
  } else if (bluePct > 0.6) {
    nudge.className = 'energy-nudge'; nudge.innerHTML = L.nudgeLotsBlue;
  } else if (greenPct > 0 && drainPct > 0 && drainPct <= 0.7) {
    nudge.className = 'energy-nudge positive'; nudge.innerHTML = L.nudgeNiceBalance;
  } else if (counts.green > 0) {
    nudge.className = 'energy-nudge positive'; nudge.innerHTML = L.nudgeGreenOnBoard;
  } else {
    nudge.style.display = 'none';
  }
}

function updateStats(tasks) {
  document.getElementById('statTotal').textContent = tasks.length;
  document.getElementById('statDone').textContent = tasks.filter(t => t.done).length;
  // Streak
  let streak = 0;
  const today = new Date();
  for (let i = 0; i < 365; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = 'myday-' + d.toISOString().slice(0, 10);
    const dayTasks = JSON.parse(localStorage.getItem(key) || '[]');
    if (dayTasks.some(t => t.done)) { streak++; } else if (i > 0) { break; }
  }
  document.getElementById('statStreak').textContent = streak;
}

function clearDay() {
  const L = currentLang.ui;
  if (confirm(L.clearDayConfirm)) {
    localStorage.removeItem(getTodayKey());
    renderTasks();
  }
}

function carryForward() {
  const L = currentLang.ui;
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayKey = 'myday-' + yesterday.toISOString().slice(0, 10);
  const oldTasks = JSON.parse(localStorage.getItem(yesterdayKey) || '[]');
  const unfinished = oldTasks.filter(t => !t.done);
  if (!unfinished.length) { alert(L.noUnfinishedAlert); return; }
  const current = getTasks();
  unfinished.forEach(t => { t.id = Date.now() + Math.random(); current.push(t); });
  saveTasks(current);
  renderTasks();
}

// ============ TIMER UTILITIES ============

function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${m}:${sec.toString().padStart(2, '0')}`;
}

function startTimer(btnEl, seconds) {
  const id = btnEl.dataset.timerId;
  if (activeTimers[id]) {
    clearInterval(activeTimers[id]);
    delete activeTimers[id];
    btnEl.classList.remove('running');
    btnEl.querySelector('.timer-display').textContent = formatTime(seconds);
    return;
  }
  let remaining = seconds;
  btnEl.classList.add('running');
  const display = btnEl.querySelector('.timer-display');
  display.textContent = formatTime(remaining);
  activeTimers[id] = setInterval(() => {
    remaining--;
    display.textContent = formatTime(remaining);
    if (remaining <= 0) {
      clearInterval(activeTimers[id]);
      delete activeTimers[id];
      btnEl.classList.remove('running');
      const L = currentLang.ui;
      display.textContent = L.timerDone;
      try { new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdW+HjYyGgHd0eH2DhomIhX95dXZ7gIaJiYZ/eHR2e4CGiomGf3h0dnt/hoqJhn94dHZ7f4aKiYZ/eHR2e3+GiomGf3h0dQ==").play(); } catch {}
      setTimeout(() => { display.textContent = formatTime(seconds); }, 3000);
    }
  }, 1000);
}

// ============ FAVORITES SYSTEM ============
function getFavorites() {
  try { return JSON.parse(localStorage.getItem('adhd-favorites') || '[]'); } catch { return []; }
}
function saveFavorites(favs) { localStorage.setItem('adhd-favorites', JSON.stringify(favs)); }
function toggleFavorite(id) {
  let favs = getFavorites();
  const idx = favs.indexOf(id);
  if (idx > -1) { favs.splice(idx, 1); } else { favs.push(id); }
  saveFavorites(favs);
  document.querySelectorAll(`.fav-btn[data-fav-id="${id}"]`).forEach(btn => {
    btn.classList.toggle('favorited', favs.includes(id));
    btn.innerHTML = favs.includes(id) ? '‚≠ê' : '<span style="color:#9595B0;font-size:1.1rem">‚ú©</span>';
  });
  renderFavorites();
}

// ============ QUIZ ============

function renderQuiz() {
  const L = currentLang.ui;
  const card = document.getElementById('quizCard');
  if (quizStep >= quizQuestions.length) { renderQuizResult(); return; }
  const q = quizQuestions[quizStep];
  const progressHTML = quizQuestions.map((_, i) => `<div class="quiz-dot ${i < quizStep ? 'filled' : ''}"></div>`).join('');
  card.innerHTML = `
    <div class="quiz-progress">${progressHTML}</div>
    <div class="quiz-question">${q.q}</div>
    <div class="quiz-answers">
      ${q.answers.map((a, i) => `<div class="quiz-answer" onclick="selectQuizAnswer(${i})">${a.text}</div>`).join('')}
    </div>
  `;
}

function selectQuizAnswer(idx) {
  const q = quizQuestions[quizStep];
  const scores = q.answers[idx].scores;
  Object.keys(scores).forEach(k => { quizScores[k] = (quizScores[k] || 0) + scores[k]; });
  quizStep++;
  renderQuiz();
}

function renderQuizResult() {
  const L = currentLang.ui;
  const card = document.getElementById('quizCard');
  const winner = Object.entries(quizScores).sort((a,b) => b[1] - a[1])[0][0];
  const result = patternResults[winner];
  const pattern = patterns.find(p => p.title === result.title);
  const strategies = pattern ? pattern.strategies : [];
  card.innerHTML = `
    <div class="quiz-result">
      <div class="quiz-result-icon">${result.icon}</div>
      <h3 style="color:${result.color}">${result.title}</h3>
      <p>${result.desc}</p>
      <div class="quiz-result-strategies">
        <h4>${L.quizTargetedStrategies}</h4>
        <ul>${strategies.map(s => `<li>${s}</li>`).join('')}</ul>
      </div>
      <button class="quiz-go-btn" onclick="switchToPage('patterns')">${L.quizSeeAllPatterns}</button>
      <br>
      <button class="quiz-restart" onclick="restartQuiz()">${L.quizRetake}</button>
    </div>
  `;
}

function restartQuiz() {
  quizStep = 0;
  quizScores = { speed: 0, fire: 0, blue: 0, redblue: 0 };
  renderQuiz();
}

// ============ LADDER TRACKER ============
function getLadderHistory() { try { return JSON.parse(localStorage.getItem('ladder-history') || '{}'); } catch { return {}; } }
function saveLadderHistory(h) { localStorage.setItem('ladder-history', JSON.stringify(h)); }

function logLadder(level) {
  const today = new Date().toISOString().slice(0, 10);
  const history = getLadderHistory();
  history[today] = level;
  saveLadderHistory(history);
  renderLadderHistory();
}

function renderLadderHistory() {
  const L = currentLang.ui;
  const history = getLadderHistory();
  const container = document.getElementById('ladderHistory');
  const today = new Date().toISOString().slice(0, 10);
  const todayLevel = history[today];

  // Highlight today's button
  document.querySelectorAll('.ladder-checkin-btn').forEach(btn => btn.classList.remove('today-active'));
  if (todayLevel) {
    const activeBtn = document.querySelector(`.lcb-${todayLevel}`);
    if (activeBtn) activeBtn.classList.add('today-active');
  }

  // Render last 14 days
  const days = [];
  for (let i = 13; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const key = d.toISOString().slice(0, 10);
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    days.push({ date: key, level: history[key], label: dayNames[d.getDay()] + ' ' + d.getDate() });
  }

  if (!Object.keys(history).length) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = `
    <div class="ladder-history-title">${L.ladderHistoryTitle}</div>
    <div class="ladder-history-row">
      ${days.map(d => d.level
        ? `<div class="ladder-history-dot lhd-${d.level}" title="${d.label}">${d.level}</div>`
        : `<div class="ladder-history-dot lhd-empty" title="${d.label}">¬∑</div>`
      ).join('')}
    </div>
  `;
}

// Note: renderLadderHistory() is called by setLanguage() via renderLadderPage()
</script>
</body>
</html>
